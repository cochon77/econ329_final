---
title: "final_project"
author: "Colin Pi"
date: '2018 5 28 '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(car)
library(lmtest)
library(orcutt)
library(sandwich)
library(stargazer)
```

```{r}
income <- read_excel("CLASS.xls", skip = 3)[-1,] %>% select(Economy, `Income group`)
names(income)[1:2] <- c("Country","Income")

WBData <- read.csv("WBData.csv")[-c(131:135),]
names(WBData)[5:62] <- seq(1960,2017)
names(WBData)[3:4] <- c("Country","Code")

narrow <- function(i){
  outcome <- gather(WBData %>% filter(Series.Name == levels(WBData$Series.Name)[i]), key = Year, value = UQ(levels(WBData$Series.Name)[i]), 5:62) %>% select(6)
  return(outcome)
}

WBNarrow <- gather(WBData %>% 
                     filter(Series.Name == levels(WBData$Series.Name)[2]), 
                   key = Year, value = UQ(levels(WBData$Series.Name)[2]), 5:62) %>% 
  select(-c(1:2)) %>% bind_cols(lapply(c(3,5:6,8), narrow) %>% bind_cols())

WBNarrow[,4:8] <- sapply(WBNarrow[,4:8], as.numeric)
names(WBNarrow)[4:8] <- 
  c("Growth", "Health","Education", "Capital", "Trade")

WBNarrow <- left_join(WBNarrow, income)
WBNarrow$Year <- as.numeric(WBNarrow$Year)
```

## CPI Index

```{r}
cpi_2017 <- read_excel("CPI2017_FullDataSet.xlsx", skip=2)
cpi_2017 <- cpi_2017 %>% select(1,4)
names(cpi_2017)[2] = "2017"

cpi_2016 <- read_excel("CPI2016_FullDataSetWithRegionalTables.xlsx")
cpi_2016 <- cpi_2016 %>% select(1:2)
colnames(cpi_2016)[2] = "2016"

cpi_2016_17 <- full_join(cpi_2016,cpi_2017, by = "Country")
cpi_2016_17 <- cpi_2016_17[-(181:182),]

cpi_1998_2015 <- read_excel("CPI1998-2015.xlsx")
cpi_total <- full_join(cpi_1998_2015, cpi_2016_17, by = "Country")

cpi_total[,2:21] <- sapply(cpi_total[,2:21],as.numeric)

cpi_total <- cpi_total %>% mutate_at(.vars = vars(names(cpi_total)[2:15]), funs(.*10))

CPI <- gather(data = cpi_total, key = Year, value = CPI, 2:21)
CPI$Year <- as.numeric(CPI$Year)
```

```{r}
allData <- left_join(WBNarrow, CPI)
```

These are the names of the variables:

"Adjusted net national income per capita (annual % growth)"                                      
"Current health expenditure (% of GDP)"                                                          
"Government expenditure on education, total (% of government expenditure)"                       
"Gross capital formation (% of GDP)"                                                             
"Trade (% of GDP)"
"Corruption Perception Index"

## Growth v. Education

```{r}
ggplot(allData, aes(x = Education, y = Growth)) + 
  geom_point() +
  geom_smooth(method = "lm") + 
  scale_x_continuous(limits = c(0,25)) +
  labs(x = "Education Expenditure (% of Govt Expenditure)", y = "Annual Growth Rate per Capita (%)", title = "Growth Rate v. Education Expenditure")
```

## Fixed Effect

```{r}
ggplot(allData, aes(x = Education, y = Growth, color = Income)) + 
  geom_smooth(method = "lm") + 
  labs(x = "Education Expenditure (% of Govt Expenditure)", y = "Annual Growth Rate per Capita (%)", title = "Growth Rate v. Education Expenditure")
```

## Necessary Transformation

```{r}
scatterplotMatrix(allData[c(4:8,10)])
```

## Model

```{r}
bivariate.lm <- lm(Growth~Education, data = allData)
summary(bivariate.lm)

growth.lm <- lm(Growth ~ log(Trade) + Health + Capital + CPI + factor(Income) + Education, data = na.omit(allData))
summary(growth.lm)
```

## Multicollinearity

```{r}
vif(growth.lm)
```

## Heteroscedasity

```{r}
ggplot(growth.lm, aes(x=na.omit(allData)$Education, y=.resid)) + 
  geom_jitter() +
  geom_hline(yintercept=0, col="red", linetype="dashed") +
  labs(title = "Residual vs Year", x="Year", y = "Residuals")

gqtest(growth.lm, fraction = 4, order.by = na.omit(allData)$Education)
```

## Autocorrelation

```{r}
ggplot(growth.lm, aes(x=na.omit(allData)$Year, y=.resid)) + 
  geom_jitter() +
  geom_hline(yintercept=0, col="red", linetype="dashed") +
  labs(title = "Residual vs Year", x="Year", y = "Residuals")

dwtest(growth.lm, order.by = na.omit(allData)$Year)
bgtest(growth.lm, order.by = na.omit(allData)$Year)

growth.orcutt <- cochrane.orcutt(growth.lm)
summary.orcutt(growth.orcutt)

growth.newey <- coeftest(growth.lm, vcov = NeweyWest(growth.lm))
growth.newey
```
